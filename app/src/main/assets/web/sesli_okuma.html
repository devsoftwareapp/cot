<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>PDF Sesli Okuma</title>

<style>
body {
  margin: 0;
  background: #f4f4f4;
  font-family: Arial;
}
#topBar {
  padding: 10px;
  background: #222;
  color: #fff;
  display: flex;
  gap: 10px;
  align-items: center;
}
#viewerFrame {
  width: 100%;
  height: calc(100vh - 120px);
  border: none;
}
#controls {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  background: #ddd;
  border-top: 1px solid #aaa;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
</style>

</head>
<body>

<!-- √úST BAR -->
<div id="topBar">
  <button onclick="selectPDF()">üìÑ PDF Se√ß</button>
</div>

<!-- PDF VIEWER ƒ∞FRAME -->
<iframe id="viewerFrame"></iframe>

<!-- TTS BUTONLARI -->
<div id="controls">
  <button onclick="prevPara()">‚èÆ Geri</button>
  <button onclick="togglePlay()" id="playBtn">‚ñ∂ Oynat</button>
  <button onclick="nextPara()">‚è≠ ƒ∞leri</button>
</div>


<script>
let extractedText = [];
let currentIndex = 0;
let isPlaying = false;

/* ----------------------------------------------------------
   1) PDF Se√ß ‚Üí Android ‚Üí Base64 al ‚Üí viewer.html‚Äôe y√ºkle
----------------------------------------------------------- */
function selectPDF() {
    if (window.Android && Android.selectSpeechPDF) {
        Android.selectSpeechPDF(); // Android tarafƒ±nda PDF se√ßtir
    } else {
        alert("Android.selectSpeechPDF bulunamadƒ±");
    }
}

/* ----------------------------------------------------------
   2) Android ‚Üí se√ßilen PDF‚Äôi base64 olarak geri g√∂nderir
      Bunu Android evaluateJavascript ile √ßaƒüƒ±rmalƒ±:
      window.onPDFBase64Selected(base64)
----------------------------------------------------------- */
window.onPDFBase64Selected = function(base64) {
    const url = "viewer.html?base64=" + encodeURIComponent(base64);
    document.getElementById("viewerFrame").src = url;
};

/* ----------------------------------------------------------
   3) viewer.html ‚Üí bize TEXT_EXTRACTED mesajƒ± g√∂nderir
----------------------------------------------------------- */
window.addEventListener("message", function (event) {
    if (event.data?.type === "TEXT_EXTRACTED") {
        extractedText = event.data.text;
        currentIndex = 0;
        console.log("Metin alƒ±ndƒ±:", extractedText);
    }
});

/* ----------------------------------------------------------
   4) TTS KONTROLLERƒ∞
----------------------------------------------------------- */
function togglePlay() {
    if (!extractedText.length) {
        alert("PDF metni hen√ºz √ßƒ±karƒ±lmadƒ±!");
        return;
    }

    if (!isPlaying) {
        speak(extractedText[currentIndex]);
        isPlaying = true;
        document.getElementById("playBtn").innerText = "‚è∏ Durdur";
    } else {
        AndroidTTS.stop();
        isPlaying = false;
        document.getElementById("playBtn").innerText = "‚ñ∂ Oynat";
    }
}

function speak(text) {
    if (window.AndroidTTS) {
        AndroidTTS.speak(text, detectLang(text), 1.0);
    } else {
        if (Android && Android.speakText)
            Android.speakText(text, detectLang(text), 1.0);
    }
}

function nextPara() {
    if (currentIndex < extractedText.length - 1) {
        currentIndex++;
        speak(extractedText[currentIndex]);
    }
}

function prevPara() {
    if (currentIndex > 0) {
        currentIndex--;
        speak(extractedText[currentIndex]);
    }
}

/* ----------------------------------------------------------
   5) Basit dil algƒ±lama
----------------------------------------------------------- */
function detectLang(text) {
    text = text.toLowerCase();
    if (/[ƒ±ƒü√º≈ü√∂√ß]/.test(text)) return "tr-TR";
    if (/[–∞-—è]/.test(text)) return "ru-RU";
    if (/[√©√®√ß√†√π√¢√™√Æ√¥√ª]/.test(text)) return "fr-FR";
    if (/[√°√©√≠√≥√∫√±]/.test(text)) return "es-ES";
    return "en-US";
}

/* ----------------------------------------------------------
   6) TTS bitince devam etmesi
----------------------------------------------------------- */
window.onTTSDone = function () {
    if (!isPlaying) return;

    if (currentIndex < extractedText.length - 1) {
        currentIndex++;
        speak(extractedText[currentIndex]);
    } else {
        isPlaying = false;
        document.getElementById("playBtn").innerText = "‚ñ∂ Oynat";
    }
};
</script>

</body>
</html>

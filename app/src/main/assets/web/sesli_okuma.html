<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PDF Reader - Speech</title>
  
  <style>
    @font-face {
      font-family: "MaterialIcons";
      src: url("file:///android_asset/web/fonts/MaterialSymbolsRounded.woff2") format("woff2");
    }
    
    .material-icons {
      font-family: "MaterialIcons";
      font-size: 24px;
      font-weight: normal;
      font-style: normal;
      display: inline-block;
      line-height: 1;
    }
    
    /* --- BASE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; 
      font-family: 'Roboto', sans-serif; 
      overflow: hidden; 
    }
    
    /* --- SPEECH BAR --- */
    #speechBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #222;
      color: #fff;
      z-index: 999999;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    
    .speech-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .speech-row:last-child {
      margin-bottom: 0;
    }
    
    .speech-btn {
      padding: 8px 12px;
      background: #333;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 40px;
    }
    
    .speech-btn:active {
      background: #444;
    }
    
    .speech-btn.primary {
      background: #007bff;
    }
    
    .speech-input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #333;
      color: white;
      font-size: 13px;
      text-align: center;
      width: 60px;
    }
    
    .speech-select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #333;
      color: white;
      font-size: 13px;
      min-width: 120px;
    }
    
    .speech-status {
      font-size: 12px;
      color: #ccc;
      padding: 6px 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      text-align: center;
      flex: 1;
    }
    
    /* --- CONTROLS --- */
    .nav-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      width: 100%;
    }
    
    .nav-btn {
      width: 50px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-btn.play {
      width: 60px;
      height: 45px;
      background: #007bff;
    }
    
    /* --- PDF VIEWER ADJUSTMENTS --- */
    body {
      padding-top: 120px !important;
    }
    
    /* Hide PDF.js toolbar */
    #toolbarContainer {
      display: none !important;
    }
    
    /* Adjust viewer position */
    #viewerContainer {
      padding-top: 0 !important;
      height: calc(100vh - 120px) !important;
    }
    
    /* --- MOBILE --- */
    @media (max-width: 768px) {
      #speechBar {
        padding: 6px;
      }
      
      .speech-row {
        gap: 6px;
      }
      
      .speech-btn {
        padding: 6px 8px;
        font-size: 12px;
      }
      
      .speech-input {
        width: 50px;
        padding: 6px;
      }
      
      .speech-select {
        min-width: 100px;
        padding: 6px;
        font-size: 12px;
      }
      
      .nav-btn {
        width: 45px;
        height: 38px;
      }
      
      .nav-btn.play {
        width: 50px;
        height: 40px;
      }
      
      body {
        padding-top: 110px !important;
      }
      
      #viewerContainer {
        height: calc(100vh - 110px) !important;
      }
    }
    
    /* --- HIGHLIGHT --- */
    .highlight-current-sentence {
      background-color: rgba(255, 255, 0, 0.5) !important;
      transition: background-color 0.3s ease !important;
    }
  </style>
</head>
<body>
  <!-- Hidden file input for PDF selection -->
  <input type="file" id="pdfInput" accept=".pdf" style="display:none">

  <!-- SPEECH CONTROLS -->
  <div id="speechBar">
    <!-- Row 1: PDF selection, page input, speed -->
    <div class="speech-row">
      <button class="speech-btn" id="choosePDF" title="Choose PDF">
        <span class="material-icons">folder_open</span> PDF
      </button>
      
      <input type="number" class="speech-input" id="startPageInput" placeholder="Page" min="1">
      <button class="speech-btn" id="startPageBtn" title="Start from page">
        <span class="material-icons">arrow_forward</span>
      </button>
      
      <select class="speech-select" id="speechRate">
        <option value="0.75">0.75x</option>
        <option value="1" selected>1.0x</option>
        <option value="1.25">1.25x</option>
        <option value="1.5">1.5x</option>
        <option value="2">2.0x</option>
      </select>
      
      <select class="speech-select" id="languageSelector" title="Select language">
        <option value="en-US">English</option>
        <option value="fr-FR">French</option>
      </select>
    </div>
    
    <!-- Row 2: Navigation controls and status -->
    <div class="speech-row">
      <div class="nav-controls">
        <button class="speech-btn nav-btn" id="ttsPrev" title="Previous sentence">
          <span class="material-icons">skip_previous</span>
        </button>
        
        <button class="speech-btn nav-btn play" id="ttsPlay" title="Play/Pause">
          <span class="material-icons" id="playIcon">play_arrow</span>
        </button>
        
        <button class="speech-btn nav-btn" id="ttsNext" title="Next sentence">
          <span class="material-icons">skip_next</span>
        </button>
      </div>
      
      <div class="speech-status" id="speechStatus">Ready</div>
    </div>
  </div>

  <!-- PDF.js viewer container -->
  <div id="viewerContainer"></div>

  <script>
    // ==================== ANDROID TTS FUNCTIONS ====================
    function initAndroidTTS() {
      if (typeof Android !== 'undefined' && Android.initTTS) {
        Android.initTTS();
        console.log("Android TTS initialized");
        return true;
      }
      return false;
    }
    
    function speakWithAndroid(text, lang, rate) {
      if (typeof Android !== 'undefined') {
        if (Android.speakTextWithRate) {
          Android.speakTextWithRate(text, lang, rate);
          return true;
        } else if (Android.speakText) {
          Android.speakText(text, lang);
          return true;
        } else if (Android.speak) {
          Android.speak(text, lang);
          return true;
        }
      }
      return false;
    }
    
    function stopAndroidTTS() {
      if (typeof Android !== 'undefined' && Android.stop) {
        Android.stop();
        return true;
      }
      return false;
    }
    
    // ==================== VARIABLES ====================
    let sentences = [];
    let currentIndex = 0;
    let isPlaying = false;
    let ttsSpeed = 1.0;
    let currentLanguage = 'en-US';
    let currentPDF = null;
    
    // ==================== ELEMENT REFERENCES ====================
    const elements = {
      choosePDF: document.getElementById('choosePDF'),
      startPageInput: document.getElementById('startPageInput'),
      startPageBtn: document.getElementById('startPageBtn'),
      ttsPrev: document.getElementById('ttsPrev'),
      ttsPlay: document.getElementById('ttsPlay'),
      ttsNext: document.getElementById('ttsNext'),
      playIcon: document.getElementById('playIcon'),
      speechStatus: document.getElementById('speechStatus'),
      speechRate: document.getElementById('speechRate'),
      languageSelector: document.getElementById('languageSelector'),
      pdfInput: document.getElementById('pdfInput')
    };
    
    // ==================== UTILITY FUNCTIONS ====================
    function updateStatus(message) {
      elements.speechStatus.textContent = message;
      console.log("Status:", message);
    }
    
    function setPlaying(playing) {
      isPlaying = playing;
      elements.playIcon.textContent = playing ? "pause" : "play_arrow";
    }
    
    function stopSpeech() {
      if (isPlaying) {
        setPlaying(false);
        stopAndroidTTS();
      }
    }
    
    // ==================== TEXT EXTRACTION ====================
    function extractTextFromPDF() {
      if (!window.PDFViewerApplication || !PDFViewerApplication.pdfDocument) {
        updateStatus("No PDF loaded");
        return;
      }
      
      updateStatus("Extracting text...");
      
      const pdf = PDFViewerApplication.pdfDocument;
      const totalPages = pdf.numPages;
      sentences = [];
      currentIndex = 0;
      
      // Extract text from each page
      extractPageText(1, totalPages, pdf)
        .then(() => {
          if (sentences.length > 0) {
            updateStatus(`Ready (${sentences.length} sentences)`);
            highlightCurrentSentence();
          } else {
            updateStatus("No text found in PDF");
          }
        })
        .catch(error => {
          console.error("Text extraction error:", error);
          updateStatus("Error extracting text");
        });
    }
    
    async function extractPageText(pageNum, totalPages, pdf) {
      if (pageNum > totalPages) return;
      
      try {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        
        // Combine text items
        const pageText = textContent.items
          .map(item => item.str)
          .join(' ')
          .replace(/\s+/g, ' ')
          .trim();
        
        // Split into sentences
        const pageSentences = pageText.match(/[^.!?]+[.!?]+/g) || [pageText];
        
        pageSentences.forEach(sentence => {
          if (sentence.trim().length > 2) {
            sentences.push({
              text: sentence.trim(),
              page: pageNum
            });
          }
        });
        
        // Update status every few pages
        if (pageNum % 5 === 0 || pageNum === totalPages) {
          updateStatus(`Extracting... ${pageNum}/${totalPages}`);
        }
        
        // Continue with next page
        if (pageNum < totalPages) {
          await extractPageText(pageNum + 1, totalPages, pdf);
        }
      } catch (error) {
        console.error(`Error extracting page ${pageNum}:`, error);
        // Continue with next page even if this one fails
        if (pageNum < totalPages) {
          await extractPageText(pageNum + 1, totalPages, pdf);
        }
      }
    }
    
    // ==================== SPEECH FUNCTIONS ====================
    function speakCurrent() {
      if (sentences.length === 0) {
        updateStatus("No text to speak");
        return;
      }
      
      if (currentIndex >= sentences.length) {
        currentIndex = 0;
      }
      
      const sentence = sentences[currentIndex];
      const text = sentence.text;
      
      highlightCurrentSentence();
      setPlaying(true);
      
      // Use Android TTS
      if (!speakWithAndroid(text, currentLanguage, ttsSpeed)) {
        updateStatus("TTS not available");
        setPlaying(false);
        return;
      }
      
      updateStatus(`Page ${sentence.page}: ${currentIndex + 1}/${sentences.length}`);
    }
    
    function highlightCurrentSentence() {
      // Remove previous highlights
      document.querySelectorAll('.highlight-current-sentence').forEach(el => {
        el.classList.remove('highlight-current-sentence');
      });
      
      if (sentences.length === 0 || currentIndex >= sentences.length) return;
      
      const sentence = sentences[currentIndex];
      
      // Navigate to the page
      if (window.PDFViewerApplication && PDFViewerApplication.page !== sentence.page) {
        PDFViewerApplication.page = sentence.page;
      }
      
      // Try to find and highlight the text (basic implementation)
      setTimeout(() => {
        const textLayer = document.querySelector('.textLayer');
        if (textLayer) {
          const spans = textLayer.querySelectorAll('span');
          let found = false;
          
          spans.forEach(span => {
            if (span.textContent.includes(sentence.text.substring(0, 20))) {
              span.classList.add('highlight-current-sentence');
              found = true;
              
              // Scroll to element
              span.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
              });
            }
          });
          
          if (!found) {
            // Try partial match
            const words = sentence.text.split(' ');
            if (words.length > 0) {
              spans.forEach(span => {
                if (span.textContent.includes(words[0])) {
                  span.classList.add('highlight-current-sentence');
                  span.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                  });
                }
              });
            }
          }
        }
      }, 500);
    }
    
    // ==================== PAGE NAVIGATION ====================
    function jumpToPageAndStart(pageNum) {
      const page = parseInt(pageNum);
      if (isNaN(page) || page < 1) {
        updateStatus("Invalid page number");
        return;
      }
      
      if (sentences.length === 0) {
        updateStatus("Extract text first");
        return;
      }
      
      // Find first sentence on or after the specified page
      let foundIndex = -1;
      for (let i = 0; i < sentences.length; i++) {
        if (sentences[i].page >= page) {
          foundIndex = i;
          break;
        }
      }
      
      if (foundIndex === -1) {
        foundIndex = sentences.length - 1;
      }
      
      currentIndex = foundIndex;
      stopSpeech();
      highlightCurrentSentence();
      speakCurrent();
    }
    
    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      // PDF selection
      elements.choosePDF.addEventListener('click', () => {
        elements.pdfInput.click();
      });
      
      elements.pdfInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          currentPDF = file;
          
          // Load PDF using PDF.js
          const reader = new FileReader();
          reader.onload = function(event) {
            const typedarray = new Uint8Array(event.target.result);
            
            if (window.PDFViewerApplication) {
              PDFViewerApplication.open(typedarray);
              updateStatus(`Loaded: ${file.name}`);
              
              // Extract text when PDF is loaded
              setTimeout(extractTextFromPDF, 1000);
            } else {
              updateStatus("PDF viewer not ready");
            }
          };
          reader.readAsArrayBuffer(file);
        }
      });
      
      // Start from page
      elements.startPageBtn.addEventListener('click', () => {
        const pageNum = elements.startPageInput.value;
        if (pageNum && parseInt(pageNum) > 0) {
          jumpToPageAndStart(pageNum);
        } else {
          updateStatus("Enter a valid page number");
        }
      });
      
      elements.startPageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          elements.startPageBtn.click();
        }
      });
      
      // Navigation buttons
      elements.ttsPrev.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          stopSpeech();
          highlightCurrentSentence();
          speakCurrent();
        }
      });
      
      elements.ttsNext.addEventListener('click', () => {
        if (currentIndex < sentences.length - 1) {
          currentIndex++;
          stopSpeech();
          highlightCurrentSentence();
          speakCurrent();
        }
      });
      
      elements.ttsPlay.addEventListener('click', () => {
        if (isPlaying) {
          stopSpeech();
          updateStatus("Paused");
        } else {
          if (sentences.length === 0) {
            extractTextFromPDF();
            setTimeout(() => {
              if (sentences.length > 0) {
                speakCurrent();
              }
            }, 1000);
          } else {
            speakCurrent();
          }
        }
      });
      
      // Speed control
      elements.speechRate.addEventListener('change', () => {
        ttsSpeed = parseFloat(elements.speechRate.value);
      });
      
      // Language selection
      elements.languageSelector.addEventListener('change', () => {
        currentLanguage = elements.languageSelector.value;
        const langName = elements.languageSelector.options[elements.languageSelector.selectedIndex].text;
        updateStatus(`Language: ${langName}`);
      });
      
      // Android callbacks
      window.onAndroidSpeechDone = function() {
        if (isPlaying) {
          // Move to next sentence
          if (currentIndex < sentences.length - 1) {
            currentIndex++;
            setTimeout(speakCurrent, 100);
          } else {
            // End of document
            setPlaying(false);
            updateStatus("Finished reading");
          }
        }
      };
    }
    
    // ==================== INITIALIZATION ====================
    function initialize() {
      console.log("PDF Speech Reader Initializing");
      
      // Setup event listeners
      setupEventListeners();
      
      // Initialize Android TTS
      if (typeof Android !== 'undefined') {
        console.log("Android interface available");
        initAndroidTTS();
      }
      
      updateStatus("Ready - Select a PDF");
      
      // Check for PDF viewer
      if (!window.PDFViewerApplication) {
        console.log("PDF.js not loaded, loading now...");
        loadPDFViewer();
      }
    }
    
    // ==================== LOAD PDF VIEWER ====================
    function loadPDFViewer() {
      // Create minimal PDF viewer container
      const viewerHTML = `
        <div id="outerContainer">
          <div id="mainContainer">
            <div id="viewerContainer">
              <div id="viewer" class="pdfViewer"></div>
            </div>
          </div>
        </div>
      `;
      
      document.body.innerHTML += viewerHTML;
      
      // Load PDF.js dynamically
      const script = document.createElement('script');
      script.src = 'file:///android_asset/web/build/pdf.mjs';
      script.type = 'module';
      script.onload = function() {
        console.log("PDF.js loaded");
        
        // Load viewer script
        const viewerScript = document.createElement('script');
        viewerScript.src = 'file:///android_asset/web/viewer.mjs';
        viewerScript.type = 'module';
        viewerScript.onload = function() {
          console.log("PDF viewer loaded");
          updateStatus("PDF viewer ready");
        };
        document.head.appendChild(viewerScript);
      };
      document.head.appendChild(script);
    }
    
    // ==================== START APPLICATION ====================
    document.addEventListener('DOMContentLoaded', initialize);
    
    // Android back button handler
    window.androidBackPressed = function() {
      if (isPlaying) {
        stopSpeech();
        return false;
      }
      return true;
    };
    
    // Android resume handler
    window.onAndroidResume = function() {
      console.log("App resumed");
      if (currentPDF && sentences.length === 0) {
        extractTextFromPDF();
      }
    };
    
  </script>
</body>
</html>
